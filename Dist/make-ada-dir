#!/usr/local/bin/zsh
#
# $Id$
#
# Upgrade needed files under ada for gnatdist
#
rm -rf ../newada
mkdir ../newada
rm -f sdefault.adb
make
echo -n Analyzing dependencies... >& 2
for i in `gnatmake -a -gnatpg -g -gnata -gnato -I../gnat -I../ada \
   xe_build.adb -o gnatdist -M | sed -e 's/^.*://' | sed -e 's/\\\\//'`; do
cp $i ../newada/ 2> /dev/null
echo -n . >& 2
done
echo
echo Removing gnatdist files
rm -f ../newada/xe*
echo Removing sdefault.adb
rm -f ../newada/sdefault.adb
echo Removing files that are part of the system library
adainclude=`./config.sdefault pathtolib | \
  sed -e 's,adalib.*$,adainclude,'`
for i in ../newada/*(.); do
  if [ -f $adainclude/`basename $i` ]; then
    rm -f ../newada/$i
  fi
done
echo Diffing directories
for i in ../ada/*(.); do
if [ ! -f ../newada/`basename $i` ]; then
  echo `basename $i` is no longer needed
fi
done
for i in ../newada/*(.); do
if [ ! -f ../ada/`basename $i` ]; then
  echo `basename $i` is needed
fi
done
